From aecbb61edbbe4b423fffe598bb5c254b5ec1fde8 Mon Sep 17 00:00:00 2001
From: Ryan Davis <ryan.davis.dev@gmail.com>
Date: Sun, 15 May 2016 10:25:31 +1000
Subject: [PATCH] Fix crash due to reallocation of shared memory

---
 cocos/renderer/CCQuadCommand.cpp | 15 ++++++++++++---
 cocos/renderer/CCQuadCommand.h   |  1 +
 2 files changed, 13 insertions(+), 3 deletions(-)

diff --git a/cocos/renderer/CCQuadCommand.cpp b/cocos/renderer/CCQuadCommand.cpp
index 9467eb2..c26eee6 100644
--- a/cocos/renderer/CCQuadCommand.cpp
+++ b/cocos/renderer/CCQuadCommand.cpp
@@ -39,13 +39,18 @@ NS_CC_BEGIN
 int QuadCommand::__indexCapacity = -1;
 GLushort* QuadCommand::__indices = nullptr;
 
-QuadCommand::QuadCommand()
-: _indexSize(-1)
+QuadCommand::QuadCommand():
+_indexSize(-1),
+_ownedIndices(nullptr)
 {
 }
 
 QuadCommand::~QuadCommand()
 {
+    if (_ownedIndices)
+    {
+        free(_ownedIndices);
+    }
 }
 
 void QuadCommand::init(float globalOrder, GLuint textureID, GLProgramState* glProgramState, const BlendFunc& blendType, V3F_C4B_T2F_Quad* quads, ssize_t quadCount,
@@ -70,7 +75,11 @@ void QuadCommand::reIndex(int indicesCount)
     if (indicesCount > __indexCapacity)
     {
         CCLOG("cocos2d: QuadCommand: resizing index size from [%d] to [%d]", __indexCapacity, indicesCount);
-        __indices = (GLushort*) realloc(__indices, indicesCount * sizeof(__indices[0]));
+        if (__indices)
+        {
+            _ownedIndices = __indices;
+        }
+        __indices = (GLushort*) malloc(indicesCount * sizeof(__indices[0]));
         __indexCapacity = indicesCount;
     }
 
diff --git a/cocos/renderer/CCQuadCommand.h b/cocos/renderer/CCQuadCommand.h
index e54674a..9d5a417 100644
--- a/cocos/renderer/CCQuadCommand.h
+++ b/cocos/renderer/CCQuadCommand.h
@@ -69,6 +69,7 @@ protected:
     void reIndex(int indices);
 
     int _indexSize;
+    GLushort* _ownedIndices;
 
     // shared across all instances
     static int __indexCapacity;
-- 
2.8.1

